{% extends "Advertisement/base.html" %}

{% block content %}
<h2 class="mb-3">Reklam Ekle</h2>
<form method="post" enctype="multipart/form-data" class="mb-5">
    {% csrf_token %}
    {{ form.as_p }}
    <input type="hidden" id="id_latitude" name="latitude">
    <input type="hidden" id="id_longitude" name="longitude">
    <button type="submit" class="btn btn-primary">Reklamı Ekle</button>
</form>

<div id="map" style="width: 100%; height: 400px;"></div>

<h2 class="mb-3">Mevcut Reklamlar</h2>
<div class="row">
    {% for ad in ads %}
    <div class="col-md-4">
        <div class="card mb-4">
            <img src="{{ ad.image.url }}" alt="{{ ad.title }}" class="card-img-top">
            <div class="card-body">
                <h5 class="card-title">{{ ad.title }}</h5>
                <a href="{% url 'edit_ad' ad.id %}" class="btn btn-warning">Düzenle</a>
                <a href="#" class="btn btn-danger" data-id="{{ ad.id }}" onclick="deleteAd(this);">Sil</a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
<script>
    function deleteAd(element) {
        const adId = element.getAttribute('data-id');
        if (!adId) {
            alert('Bir hata oluştu. Lütfen sayfayı yenileyip tekrar deneyin.');
            return;
        }

        fetch(`/delete/${adId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Network response was not ok');
        })
        .then(data => {
            if (data.success) {
                element.closest('.col-md-4').remove();
            } else {
                alert('Hata: Reklam silinemedi.');
            }
        })
        .catch(error => {
            alert('Bir hata oluştu: ' + error.message);
        });
    }

    // Harita başlatma
    var map = L.map('map').setView([40.4093, 49.8671], 13);  // Türkiye'nin genel koordinatları

    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxBounds: [
            [40.3000, 49.7000],
            [40.5000, 50.0000]
        ],
        maxBoundsViscosity: 1.0,
        maxZoom: 18,
        minZoom: 10
    }).addTo(map);
    
    map.setMaxBounds([
        [40.3000, 49.7000],
        [40.5000, 50.0000]
    ]);

    var circle = null;

    // Haritaya tıklama işlevini ekleyin
    map.on('click', function(e) {
        if (circle) {  // Eğer önceden eklenmiş bir daire varsa kaldır
            map.removeLayer(circle);
        }

        var radius = 1000;  // 3 km
        circle = L.circle(e.latlng, radius).addTo(map);

        document.getElementById('id_latitude').value = e.latlng.lat;
        document.getElementById('id_longitude').value = e.latlng.lng;
    });
</script>
{% endblock %}
